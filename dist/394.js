"use strict";(self.webpackChunkhaiix_editor=self.webpackChunkhaiix_editor||[]).push([[394],{394:(e,t,n)=>{n.r(t),n.d(t,{default:()=>m,passwordPrompt:()=>p});var a=n(8392),i=n(8537),s=n(2977);const o=".zip",r="my-save-dialog";(0,s.Ay)(`\n  .${r}-body label {\n    display: block;\n    white-space: nowrap;\n    height: 24px;\n  }\n  .${r}-body label > span {\n    display: inline-block;\n    width: 100px;\n  }\n  .${r}-body details {\n    margin-top: 8px;\n  }\n  .${r}-body summary {\n    height: 24px;\n    color: #08E;\n    cursor: pointer;\n  }\n  .${r}-body summary:hover {\n    text-decoration: underline;\n  }\n`);const l=i.Ay.create(class extends i.Ay{constructor(e={},t=[]){super(e,t),this.form.name.value=e.arguments[1];const n=e.arguments[2];n&&(this.form.password.value=n,this.form["confirm-password"].value=n,this.details.open=!0)}titleTemplate(){return"プロジェクトを保存"}bodyTemplate(){return`\n      <form id="form" class="${r}-body" style="padding: 10px;" onsubmit="event.preventDefault()">\n        <label>\n          <span>ファイル名:</span>\n          <input name="name" /> .zip\n        </label>\n        <details id="details">\n          <summary tabindex="-1">オプション</summary>\n          <label>\n            <span>パスワード:</span>\n            <input type="password" name="password" autocomplete="none" />\n          </label>\n          <label>\n            <span>パスワード(確認):</span>\n            <input type="password" name="confirm-password" autocomplete="none" />\n          </label>\n        </details>\n      </form>\n    `}buttonsTemplate(){return'\n      <button onclick="return this.handleOK(event)">OK</button>\n      <button onclick="return this.handleCancel(event)">キャンセル</button>\n    '}handleOK(e){this.resolve(Array.from(this.form.elements).reduce(((e,t)=>(e[t.name]=t.value,e)),{}))}}),p=i.Ay.create(class extends i.XG{bodyTemplate(){return'\n      <form onsubmit="event.preventDefault()">\n        <p id="text" style="white-space: pre-wrap;"></p>\n        <input id="input" type="password" name="password" autocomplete="none" />\n      </form>\n    '}});class m{constructor(e){this.setting=e}async save(e){const t=this.setting.fileName.endsWith(".zip")?this.setting.fileName.slice(0,-4):this.setting.fileName,n=await l("",t,this.setting.password);if(!n)return!1;if(n.password!==n["confirm-password"])throw new Error("パスワードが一致しません");const a=(n.name||"untitled")+(n.name.endsWith(o)?"":o),i=n.password,s=await e(),r=await this.createEncryptedZipBlob(i,s);return this.downloadFile(a,r),this.setting.fileName=a,this.setting.password=i,!0}async createEncryptedZipBlob(e,t){const n=await this.createZip(t,{level:e?0:5});return e?await this.createZip([{path:"encrypted.zip",file:n}],{password:e,level:5}):n}async createZip(e,t){const n=new a.D7("application/zip"),i=new a.Vx(n,t);for(const t of e){const e=t.file,n={};n.directory=!e,await i.add(t.path,e?new a.nZ(e):null,n)}return await i.close(),await n.getData()}async downloadFile(e,t){const n=URL.createObjectURL(t);i.Ay.createElement(`<a href="${n}" download="${e}"></a>`).click(),URL.revokeObjectURL(n)}async load(e){const t=await(0,i.Tq)(o);if(t)return this.setting.fileName=t.name,await this.readEncryptedZipFile(t)}async readEncryptedZipFile(e){try{const t=await this.readZip(e);return 1===t.length&&"encrypted.zip"===t[0].path?await this.readZip(t[0].file):t}catch(e){throw new Error("ファイルを開けません:\n"+e.message)}}async readZip(e,t={}){const n=new a.zg(new a.nZ(e)),i=await n.getEntries();for(const e of i)if(!e.filenameUTF8&&e.msDosCompatible){const t=new TextDecoder("windows-31j");e.filename=t.decode(e.rawFilename),e.filenameUTF8=!0}let s="";for(const e of i){const t=e.filename.indexOf("/");if(""===s){if(t<0)break;s=e.filename.slice(0,t+1)}else if(t<0||e.filename.slice(0,t+1)!==s){s="";break}}return await Promise.all(i.filter((e=>!e.directory&&e.filename!==s)).map(async function(e){if(!t.password&&e.encrypted){const e=await p("パスワードを入力してください。");if(null==e)return;t.password=e,this.setting.password=e}return{path:("/"===e.filename.slice(-1)?e.filename.slice(0,-1):e.filename).slice(s.length),file:e.directory?null:await e.getData(new a.D7(this.getMimeFromExt(e.filename)),t)}}.bind(this)))}getMimeFromExt(e){return{js:"text/javascript",mjs:"text/javascript",css:"text/css",html:"text/html",htm:"text/html",txt:"text/plain",md:"text/markdown",json:"application/json",xml:"application/xml",pdf:"application/pdf",bmp:"image/bmp",gif:"image/gif",ico:"image/vnd.microsoft.icon",jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp",m3u:"audio/x-mpegurl",m4a:"audio/x-m4a",mid:"audio/midi",midi:"audio/midi",mp3:"audio/mpeg",oga:"audio/ogg",ogg:"audio/ogg",wav:"audio/wav",weba:"audio/webm",avi:"video/x-msvideo",mp4:"video/mp4",mpg:"video/mpeg",mpeg:"video/mpeg",ogv:"video/ogg",webm:"video/webm"}[e.slice(e.lastIndexOf(".")+1)]??null}}}}]);