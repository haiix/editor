"use strict";(self.webpackChunkhaiix_editor=self.webpackChunkhaiix_editor||[]).push([[834],{4834:(e,t,a)=>{a.r(t),a.d(t,{default:()=>c,passwordPrompt:()=>m});var n=a(5588),i=a(5456),s=a(1804),o=a(4857),r=a(604);const l=".zip",p=(0,r.vf)(class extends r.Vq{constructor(e={},t=[]){super(e,t),this.form.name.value=e.arguments[1];const a=e.arguments[2];a&&(this.form["confirm-password"].value=a,this.form.password.value=a,this.details.open=!0)}titleTemplate(){return"プロジェクトを保存"}bodyTemplate(){const e="my-save-dialog-body";return(0,o.ZP)(`\n      .${e} label {\n        display: block;\n        white-space: nowrap;\n        height: 24px;\n      }\n      .${e} label > span {\n        display: inline-block;\n        width: 100px;\n      }\n      .${e} details {\n        margin-top: 8px;\n      }\n      .${e} summary {\n        height: 24px;\n        color: #08E;\n        cursor: pointer;\n      }\n      .${e} summary:hover {\n        text-decoration: underline;\n      }\n    `),`\n      <form id="form" class="${e}" onsubmit="event.preventDefault()">\n        <label>\n          <span>ファイル名:</span>\n          <input name="name" /> .zip\n        </label>\n        <details id="details">\n          <summary tabindex="-1">オプション</summary>\n          <label>\n            <span>パスワード:</span>\n            <input type="password" name="password" autocomplete="none" />\n          </label>\n          <label>\n            <span>パスワード(確認):</span>\n            <input type="password" name="confirm-password" autocomplete="none" />\n          </label>\n        </details>\n      </form>\n    `}buttonsTemplate(){return'\n      <button onclick="return this.handleOK(event)">OK</button>\n      <button onclick="return this.handleCancel(event)">キャンセル</button>\n    '}handleOK(e){this.resolve(Array.from(this.form.elements).reduce(((e,t)=>(e[t.name]=t.value,e)),{}))}}),m=(0,r.vf)(class extends r.NL{bodyTemplate(){return'\n      <form onsubmit="event.preventDefault()">\n        <p id="text" style="white-space: pre-wrap;"></p>\n        <input id="input" type="password" name="password" autocomplete="none" />\n      </form>\n    '}});class c{constructor(e){this.setting=e}async save(e){const t=".zip"===this.setting.fileName.slice(-4)?this.setting.fileName.slice(0,-4):this.setting.fileName,a=await p("",t,this.setting.password);if(!a)return!1;if(a.password!==a["confirm-password"])throw new Error("パスワードが一致しません");const n=(a.name||"untitled")+(a.name.slice(-4)===l?"":l),i=a.password,s=await e(),o=await this.createEncryptedZipBlob(i,s);return this.downloadFile(n,o),this.setting.fileName=n,this.setting.password=i,!0}async createEncryptedZipBlob(e,t){const a=await this.createZip(t,{level:e?0:5});return e?await this.createZip([{path:"encrypted.zip",file:a}],{password:e,level:5}):a}async createZip(e,t){const a=new n.U5("application/zip"),i=new n._Q(a,t);for(const{file:t,path:a}of e){const e={};e.directory=!t,await i.add(a,t?new n.Nt(t):null,e)}return await i.close(),await a.getData()}async downloadFile(e,t){const a=URL.createObjectURL(t);s.Z.createElement(`<a href="${a}" download="${e}"></a>`).click(),URL.revokeObjectURL(a)}async load(e){const t=await(0,r.ZB)(l);if(t)return this.setting.fileName=t.name,await this.readEncryptedZipFile(t)}async readEncryptedZipFile(e){try{const t=await this.readZip(e);return 1===t.length&&"encrypted.zip"===t[0].path?await this.readZip(t[0].file):t}catch(e){throw new Error("ファイルを開けません:\n"+e.message)}}async readZip(e,t={}){const a=new n.Mr(new n.Nt(e)),s=await a.getEntries();for(const e of s)e.filenameUTF8||(e.filename=i.codeToString(i.convert(e.rawFilename,{to:"UNICODE"})),e.filenameUTF8=!0);let o="";for(const e of s){const t=e.filename.indexOf("/");if(""===o){if(t<0)break;o=e.filename.slice(0,t+1)}else if(t<0||e.filename.slice(0,t+1)!==o){o="";break}}return await Promise.all(s.filter((e=>!e.directory&&e.filename!==o)).map(async function(e){if(!t.password&&e.encrypted){const e=await m("パスワードを入力してください。");if(null==e)return;t.password=e,this.setting.password=e}return{path:("/"===e.filename.slice(-1)?e.filename.slice(0,-1):e.filename).slice(o.length),file:e.directory?null:await e.getData(new n.U5(this.getMimeFromExt(e.filename)),t)}}.bind(this)))}getMimeFromExt(e){return{js:"text/javascript",mjs:"text/javascript",css:"text/css",html:"text/html",htm:"text/html",txt:"text/plain",md:"text/markdown",json:"application/json",xml:"application/xml",pdf:"application/pdf",bmp:"image/bmp",gif:"image/gif",ico:"image/vnd.microsoft.icon",jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp",m3u:"audio/x-mpegurl",m4a:"audio/x-m4a",mid:"audio/midi",midi:"audio/midi",mp3:"audio/mpeg",oga:"audio/ogg",ogg:"audio/ogg",wav:"audio/wav",weba:"audio/webm",avi:"video/x-msvideo",mp4:"video/mp4",mpg:"video/mpeg",mpeg:"video/mpeg",ogv:"video/ogg",webm:"video/webm"}[e.slice(e.lastIndexOf(".")+1)]??null}}}}]);