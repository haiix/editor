"use strict";(self.webpackChunkhaiix_editor=self.webpackChunkhaiix_editor||[]).push([[834],{4834:(e,t,n)=>{n.r(t),n.d(t,{default:()=>m,passwordPrompt:()=>c});var a=n(5588),i=n(5456),s=n(1804),r=n(4857),l=n(604);const o=".zip",p=(0,l.vf)(class extends l.Vq{constructor(e={},t=[]){super(e,t),this.form.name.value=e.arguments[1];const n=e.arguments[2];n&&(this.form["confirm-password"].value=n,this.form.password.value=n,this.details.open=!0)}titleTemplate(){return"プロジェクトを保存"}bodyTemplate(){const e="my-save-dialog-body";return(0,r.ZP)(`\n      .${e} label {\n        display: block;\n        white-space: nowrap;\n        height: 24px;\n      }\n      .${e} label > span {\n        display: inline-block;\n        width: 100px;\n      }\n      .${e} details {\n        margin-top: 8px;\n      }\n      .${e} summary {\n        height: 24px;\n        color: #08E;\n        cursor: pointer;\n      }\n      .${e} summary:hover {\n        text-decoration: underline;\n      }\n    `),`\n      <form id="form" class="${e}" onsubmit="event.preventDefault()">\n        <label>\n          <span>ファイル名:</span>\n          <input name="name" /> .zip\n        </label>\n        <details id="details">\n          <summary tabindex="-1">オプション</summary>\n          <label>\n            <span>パスワード:</span>\n            <input type="password" name="password" autocomplete="none" />\n          </label>\n          <label>\n            <span>パスワード(確認):</span>\n            <input type="password" name="confirm-password" autocomplete="none" />\n          </label>\n        </details>\n      </form>\n    `}buttonsTemplate(){return'\n      <button onclick="return this.handleOK(event)">OK</button>\n      <button onclick="return this.handleCancel(event)">キャンセル</button>\n    '}handleOK(e){this.resolve(Array.from(this.form.elements).reduce(((e,t)=>(e[t.name]=t.value,e)),{}))}}),c=(0,l.vf)(class extends l.NL{bodyTemplate(){return'\n      <form onsubmit="event.preventDefault()">\n        <p id="text" style="white-space: pre-wrap;"></p>\n        <input id="input" type="password" name="password" autocomplete="none" />\n      </form>\n    '}});class m{constructor(e){this.setting=e}async save(e){const t=".zip"===this.setting.fileName.slice(-4)?this.setting.fileName.slice(0,-4):this.setting.fileName,n=await p("",t,this.setting.password);if(!n)return!1;if(n.password!==n["confirm-password"])throw new Error("パスワードが一致しません");const a=(n.name||"untitled")+(n.name.slice(-4)===o?"":o),i=n.password,s=await e(),r=await this.createEncryptedZipBlob(i,s);return this.downloadFile(a,r),this.setting.fileName=a,this.setting.password=i,!0}async createEncryptedZipBlob(e,t){const n=await this.createZip(t,{level:e?0:5});return e?await this.createZip([{path:"encrypted.zip",file:n}],{password:e,level:5}):n}async createZip(e,t){const n=new a.U5("application/zip"),i=new a._Q(n,t);for(const{file:t,path:n}of e){const e={};e.directory=!t,await i.add(n,t?new a.Nt(t):null,e)}return await i.close(),await n.getData()}async downloadFile(e,t){const n=URL.createObjectURL(t);s.Z.createElement(`<a href="${n}" download="${e}"></a>`).click(),URL.revokeObjectURL(n)}async load(e){const t=await(0,l.ZB)(o);if(t)return this.setting.fileName=t.name,await this.readEncryptedZipFile(t)}async readEncryptedZipFile(e){try{const t=await this.readZip(e);return 1===t.length&&"encrypted.zip"===t[0].path?await this.readZip(t[0].file):t}catch(e){throw new Error("ファイルを開けません:\n"+e.message)}}async readZip(e,t={}){const n=new a.Mr(new a.Nt(e)),s=await n.getEntries();for(const e of s)e.filenameUTF8||(e.filename=i.codeToString(i.convert(e.rawFilename,{to:"UNICODE"})),e.filenameUTF8=!0);let r="";for(const e of s){const t=e.filename.indexOf("/");if(""===r){if(t<0)break;r=e.filename.slice(0,t+1)}else if(t<0||e.filename.slice(0,t+1)!==r){r="";break}}return await Promise.all(s.filter((e=>!e.directory&&e.filename!==r)).map(async function(e){if(!t.password&&e.encrypted){const e=await c("パスワードを入力してください。");if(null==e)return;t.password=e,this.setting.password=e}return{path:("/"===e.filename.slice(-1)?e.filename.slice(0,-1):e.filename).slice(r.length),file:e.directory?null:await e.getData(new a.U5(this.getMimeFromExt(e.filename)),t)}}.bind(this)))}getMimeFromExt(e){return{js:"text/javascript",mjs:"text/javascript",css:"text/css",html:"text/html",htm:"text/html",json:"application/json",xml:"application/xml",gif:"image/gif",png:"image/png",jpeg:"image/jpeg",jpg:"image/jpeg",svg:"image/svg+xml",txt:"text/plain",md:"text/markdown"}[e.slice(e.lastIndexOf(".")+1)]||null}}}}]);